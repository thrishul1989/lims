<!DOCTYPE html>
<html xmlns:c="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <title>报告整合列表</title>
    <link href="${system_css}/bootstrap.min14ed.css?v=3.3.6" rel="stylesheet">
    <link href="${system_css}/font-awesome.min93e3.css?v=4.4.0" rel="stylesheet">
    <link href="${system_css}/animate.min.css" rel="stylesheet">
    <link href="${system_css}/style.min862f.css?v=4.1.0" rel="stylesheet">
    <link href="${system_css}/lims.css?v=4.1.0" rel="stylesheet">
    <link href="${system_css}/fileinput.min.css" rel="stylesheet">
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <ol class="breadcrumb">
                        <li>
                            <span>检测实验</span>
                        </li>
                        <li class="active">
                            <span>报告整合</span>
                        </li>
                    </ol>
                </div>
            </div>
            <div class="ibox ibox-table">
                <div class="ibox-title">
                    <h5>任务列表</h5>
                </div>
                <div class="ibox-content">
                    <form id="search_from" action="${base}/bpm/report/geneticCan.do" method="post" class="search-form form-inline">

                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="orderCode" value="${(searcher.orderCode)!?html}" placeholder="订单编号">
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="productCode" value="${(searcher.productCode)!?html}" placeholder="产品编号">
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="sampleCode" value="${(searcher.sampleCode)!?html}" placeholder="样本编号">
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="productName" value="${(searcher.productName)!?html}"
                                       placeholder="检测产品">
                            </div>
                        </div>

                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="control-label">是否参与：</label>
                                <select class="form-control" name="analType" data-value="${(searcher.analType)!?html}">
                                    <option value="">所有类型</option>
                                    <option value="1/0">参与技术分析</option>
                                    <option value="0/1">参与报告评审</option>
                                    <option value="1/1">参与技术分析与报告评审</option>
                                    <option value="0/0">不参与</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="testUnit" value="${(searcher.testUnit)!?html}"
                                       placeholder="送检单位">
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="customer" value="${(searcher.customer)!?html}"
                                       placeholder="客户">
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="technicalMan" value="${(searcher.technicalMan)!?html}"
                                       placeholder="技术负责人">
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="productDutyMan" value="${(searcher.productDutyMan)!?html}"
                                       placeholder="产品负责人">
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <input type="text" class="form-control" name="inspectMan" value="${(searcher.inspectMan)!?html}"
                                       placeholder="受检人">
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <input type="text" id="startDate" class="form-control laydate-icon" name="startDate" placeholder="应出报告开始时间"
                                   readOnly="readOnly" style="height: 34px" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})"
                                   value="${(searcher.startDate)!?html}"/>
                        </div>

                        <div class="col-sm-2">
                            <input type="text" id="endDate" class="form-control laydate-icon" name="endDate" placeholder="应出报告结束时间"
                                   readOnly="readOnly" style="height: 34px" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})"
                                   value="${(searcher.endDate)!?html}"/>
                        </div>

                        <div class="col-sm-2">
                            <div class="form-group">
                                <label class="control-label">异常状态：</label>
                                <select class="form-control" name="resubmit" data-value="${(searcher.resubmit)!?html}">
                                    <option value="">所有状态</option>
                                    <option value="0">正常</option>
                                    <option value="1">重出</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-sm btn-success">
                                <i class="fa fa-search"></i> 查询
                            </button>
                            <button type="button" class="btn btn-sm btn-success" onclick="clearCondition('search_from')">
                                <i class="fa fa-repeat"></i> 重置
                            </button>
                            <@smm_security_resource resource = "/bpm/report/downloadData">
                            <a href="#" id="downloadData" class="btn btn-sm btn-primary">
                                <i class="fa fa-print"></i> 导出结果
                            </a>
                        </@smm_security_resource>
                        <@smm_security_resource resource = "/bpm/report/uploadZipReport">
                        <a href="#" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#myModal" onclick="clearClass()">
                            <i class="fa fa-print"></i> 批量导入报告
                        </a>
                    </@smm_security_resource>
                </div>
                </form>
                <div class="ibox-content" style="overflow: hidden; margin-top: 10px;">
                    <div style="overflow: auto">
                        <div style="height: 350px; width: 2500px;">
                            <table class="table table-striped table-bordered table-hover" style="min-width: 100%">
                                <thead>
                                <tr>
                                    <th><input type="checkbox" class="check-controller" /></th>
                                    <th class="index">序号</th>
                                    <th>订单编号</th>
                                    <th>测序编号</th>
                                    <th>产品编号</th>
                                    <th>样本编号</th>
                                    <th>受检人</th>
                                    <th>产品名称</th>
                                    <th>送检单位</th>
                                    <th>客户名称</th>
                                    <th>是否参与</th>
                                    <th>营销中心</th>
                                    <th>业务负责人</th>
                                    <th>相关技术/数据分析人员</th>
                                    <th>产品负责人</th>
                                    <th>应出报告日期</th>
                                    <th>完成情况</th>
                                    <th>状态</th>
                                    <th>是否加急</th>
                                    <th>异常状态</th>
                                    <th>异常备注</th>
                                    <th>备注</th>
                                    <th class="flexible-btns flexible-btns-2">操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                <#if (pagination.records)?? && pagination.records?has_content>
                                    <#list pagination.records as record>
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="check-instance" data-productId="${(record.mapTemplate)!?html}" value="${record.id!}" />
                                            </td>
                                            <td>${(record_index+1)!?html}</td>
                                            <td>${(record.orderCode)!?html}</td>
                                            <td>${(record.sequenceCode)!?html}</td>
                                            <td>${(record.productCode)!?html}</td>
                                            <td>${(record.sampleCode)!?html}</td>
                                            <td>${(record.sampleName)!?html}</td>
                                            <td>${(record.productName)!?html}</td>
                                            <td>${(record.testUnit)!?html}</td>
                                            <td>${(record.customer)!?html}</td>
                                            <td><@dict_entry_text category="ANALYSIS_TYPE" value=record.analType /></td>
                                            <td><#if record.marketingCenter??>
                                                <#if record.marketingCenter == '1'>
                                                    临床遗传
                                                    <#elseif record.marketingCenter == '2'>
                                                        临床肿瘤
                                                        <#elseif record.marketingCenter == '3'>
                                                            健康筛查
                                                            <#elseif record.marketingCenter == '4'>
                                                                科技服务
                                                </#if>
                                            </#if>
                                            </td>
                                            <td>${(record.businessMan)!?html}</td>
                                            <td>${(record.technicalMan)!?html}</td>
                                            <td>${(record.productDutyMan)!?html}</td>
                                            <td><#if record.shouldReportDate??> ${(record.shouldReportDate)!?string('yyyy-MM-dd')} <#else>${(record.shouldReportDate)!?html} </#if></td>
                                            <td>${(record.completeNum)!?html}/${(record.totalNum)!?html}</td>
                                            <td>
                                                <#if record.status==1 >
                                                    可出报告
                                                </#if>
                                            </td>
                                            <td>
                                                <#if record.ifUrgent??>
                                                    <#if record.ifUrgent == 1>是</#if>
                                                </#if>
                                            </td>
                                            <td>
                                                <#if record.resubmit??>
                                                    <#if record.resubmit>
                                                        <span style="color: red">重出（${(record.resubmitCount)!0}次）</span>
                                                        <#else>
                                                            <span style="color: green">正常</span>
                                                    </#if>
                                                </#if>
                                            </td>
                                            <td>${(record.remark)!?html}</td>
                                            <td>${(record.operateRemark)!?html}</td>
                                            <td>
                                                <#if record.sendStatus?? >
                                                    <#if record.sendStatus == 3>
                                                        <@smm_security_resource resource = "/bpm/report/handle.do">
                                                        <a href="${base}/bpm/report/handle.do?id=${record.id}&redirectStatus=8" class="btn btn-sm btn-success" >
                                                            <i class="fa fa-retweet"></i> 处理
                                                        </a>
                                                    </@smm_security_resource>
                                                    <#else>
                                                        <font class="label label-warning">处理中</font>
                                                </#if>
                                                <#else>
                                                    <@smm_security_resource resource = "/bpm/report/handle.do">
                                                    <a href="${base}/bpm/report/handle.do?id=${record.id}&redirectStatus=8" class="btn btn-sm btn-success" >
                                                        <i class="fa fa-retweet"></i> 处理
                                                    </a>
                                                </@smm_security_resource>
                                </#if>
                                <@smm_security_resource resource = "/bpm/report/remark.do">
                                <a onclick="showModal(event,'${record.id}','${record.status}','${(record.operateRemark)!?html}')" class="btn btn-sm btn-success">
                                    <i class="fa fa-edit"></i>备注
                                </a>
                                </@smm_security_resource>
                                </td>
                                </tr>
                                </#list>
                                <#else>
                                    <tr>
                                        <td colspan="23">暂无待处理任务</td>
                                    </tr>
                                    </#if>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <#include "../../inc/pagination.html" />
            </div>
        </div>
    </div>
</div>
</div>
<div class="modal fade" id="modify_dialog" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInRight" style="width: 550px; margin-left: 160px; margin-top: 100px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">关闭</span>
                    </button>
                    <h4 class="modal-title">备注操作</h4>
                </div>
                <div class="modal-body">
                    <form action="/bpm/report/remark.do" method="post" class="form-horizontal m-t toggle-form" id="modify_form">
                        <div style="width: 450px;">
                            <div class="form-group">
                                <label class="col-sm-2 control-label" style="width: 90px;">备注</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" id="operateRemark" name="operateRemark" rows="6" ></textarea>
                                    <input type="hidden" na me="id" />
                                    <input type="hidden" name="status" />
                                </div>
                            </div>
                        </div>
                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="save_btn" onclick="save()">保存</button>
                    <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</div>

<form action="${base}/testSheet/downloadFile" method="post" name="hiddForm" id="hiddForm">
    <input type="hidden" name="formValue" id="formValue" value="">
</form>
<#include "../excelModelDialog/report_zip_model.html" />
<script type="text/javascript" src="${system_js}/jquery.min.js?v=2.1.4"></script>
<script type="text/javascript" src="${system_js}/bootstrap.min.js"></script>
<script src="${plugins}/pagination/jquery.pagination.js"></script>
<script src="${system_js}/fileinput.min.js"></script>
<script type="text/javascript" src="${plugins}/laydate/laydate.js"></script>
<script src="${system_js}/system.js?v=1.0.0"></script>
<script type="text/javascript" >
    $(function() {
        $('.file-preview').hide();
        $('.fileinput-upload').hide();
        $('.fileinput-remove').hide();

        $('body').on('click', '.check-controller', function()
        {
            if ($(this).is(":checked"))
            {
                $(".check-instance").prop("checked", true);
            }
            else
            {
                $(".check-instance").prop("checked", false);
            }
        }).on('click', '.check-instance', function()
        {
            if (!$(this).is(":checked"))
            {
                $(".check-controller").prop("checked", false);
            }
            else
            {
                var totalCount = $(".check-instance").size();// 选项总个数
                var checkedCount = $('input[type=checkbox]:checked').length;// 选中总数
                if (totalCount == checkedCount)
                {
                    $(".check-controller").prop("checked", true);
                }
                else
                {
                    $(".check-controller").prop("checked", false);
                }
            }

        }).on(
            'click',
            '#downloadData',
            function(e)
            {
                e.preventDefault();
                var instances = $('.check-instance:checked');
                var count = instances.length;

                if (count == 0)
                {
                    alert("请至少选择一条任务");
                    return false;
                }
                var keys = [];
                var assignableDataTemplate = true;
                var result={NGS:"",CAPNGS:"",LongPCR:"",MULTIPCR:""};

                instances.each(function()
                {
                    keys.push($(this).val());
                    var obj = JSON.parse($(this).attr('data-productId'));
                    if(typeof(obj.NGS)!="undefined" && ""!=obj.NGS)
                    {
                        if(typeof(result.NGS)!="undefined" && ""!=result.NGS && result.NGS != obj.NGS)
                        {
                            assignableDataTemplate =false;
                        }else{
                            result.NGS = obj.NGS;
                        }
                    }
                    if(typeof(obj.CAPNGS)!="undefined" && ""!=obj.CAPNGS)
                    {
                        if(typeof(result.CAPNGS)!="undefined" && ""!=result.CAPNGS && result.CAPNGS != obj.CAPNGS)
                        {
                            assignableDataTemplate =false;
                        }else{
                            result.CAPNGS = obj.CAPNGS;
                        }
                    }
                    if(typeof(obj.LongPCR)!="undefined" && ""!=obj.LongPCR)
                    {
                        if(typeof(result.LongPCR)!="undefined" && ""!=result.LongPCR && result.LongPCR != obj.LongPCR)
                        {
                            assignableDataTemplate =false;
                        }else{
                            result.LongPCR = obj.LongPCR;
                        }
                    }
                    if(typeof(obj.MULTIPCR)!="undefined" && ""!=obj.MULTIPCR)
                    {
                        if(typeof(result.MULTIPCR)!="undefined" && ""!=result.MULTIPCR && result.MULTIPCR != obj.MULTIPCR)
                        {
                            assignableDataTemplate =false;
                        }else{
                            result.MULTIPCR = obj.MULTIPCR;
                        }
                    }
                });
                if (!assignableDataTemplate)//有一个不相同的模板id就返回true
                {
                    parent.layer.alert('产品包含的数据模板不一致，不能一起导出，请重新选择',{title:"提示"});
                    return false;
                }
                var reportId = keys.join(',');
                console.log(reportId+"=======================");
                $.ajax({
                    type: "POST",
                    traditional: true,
                    url: "/bpm/report/downloadData",
                    data: {reportId: reportId},
                    async: false,
                    success: function (data) {
                        $("#formValue").val(data);
                        $("#hiddForm").submit();
                    },
                    error: function () {
                        alert("failed");
                    }
                });
            });

        $("#butt").click(function () {
            var excelFileName = $('#uploadData').val();
            var formatStr = '';
            var index = excelFileName.lastIndexOf('.');
            if (excelFileName.length == 0) {
                parent.layer.alert('请选择需要上传的文件', {title: "提示"});
                return;
            } else if (index > 0) {
                formatStr = excelFileName.substring(index);
                if (!(".zip" == formatStr)) {
                    parent.layer.alert('请上传zip格式文件', {title: "提示"});
                    return;
                }
            }
            $("#butt").attr({"disabled":"disabled"});
            $.ajax({
                url: '/bpm/report/uploadZipReport',
                type: 'POST',
                cache: false,
                data: new FormData($('#uploadForm')[0]),
                processData: false,
                contentType: false
            }).done(function (map) {
                parent.layer.alert(map.msg.msg, {title: "提示"});
                window.location="/bpm/report/tasks.do";
                $('#myModal').modal('hide');
            }).fail(function (res) {
            });
        });
    });

    function clearClass() {
        $('.fileinput-upload-button').remove();
    }
    //导出数据
    function downloadData() {
        alert(1);
        return;
        var sheetId = $("#id").val();
        $.ajax({
            type: "POST",
            traditional: true,
            url: "/testing/data/downloadDTData",
            data: {sheetId: sheetId},
            async: false,
            success: function (data) {
                $("#formValue").val(data);
                $("#hiddForm").submit();
            },
            error: function () {
                alert("failed");
            }
        });
    };

    function showModal(e,id,status,operateRemark)
    {
        var e = e || window.event;
        e.preventDefault();
        console.info(operateRemark);
        $('#operateRemark').html(operateRemark);
        $('input[name="id"]').val(id);
        $('input[name="status"]').val(status);
        $('#modify_dialog').modal('show');
    }

    function save()
    {
        $("#modify_form").submit();
        $('#modify_dialog').modal('hide');
    }
</script>
</body>
</html>